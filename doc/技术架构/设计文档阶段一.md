### **设计文档：AnythingLLM 第一阶段改造 - 可定制的文档处理管道**

**版本：** 1.0
**日期：** 2025年11月24日

#### **1. 目标概述**

本阶段的核心目标是对 AnythingLLM 项目现有的文档处理（Ingestion）流程进行深度改造，构建一个基于 **意图识别（Intent Recognition）** 的、可灵活定制的自动化处理管道。旨在取代原有相对固定的处理方式，从而在文档向量化之前，极大地提升数据清洗、整理和拆分的质量与灵活性，为后续的 RAG（检索增强生成）提供更高质量的数据基础。

#### **2. 核心架构原则**

本次改造遵循一个核心原则：**“LLM 作为智能调度员，工具（Tools）作为标准执行器”**。

*   **LLM (大语言模型)**：不直接参与繁重的、重复的文本处理工作。其主要职责是**分析用户意图和文档类型**，并生成结构化的指令数据。这利用了LLM强大的理解和推理能力，同时规避了其在长文本处理中可能出现的不稳定性。
*   **工具 (MCP Tools)**：是确定性的、可复用的、标准化的程序模块。它们接收来自LLM的明确指令，并**精确地执行**一项任务（如数据提取、格式清洗等），保证了处理结果的稳定性和可靠性。

#### **3. 详细工作流程**

新的文档处理管道将按以下步骤执行：

**第 1 步：触发（Trigger）**
*   **动作**：用户在前端界面上传一个或多个文件。

**第 2 步：意图识别（Intent Recognition）**
*   **执行者**：LLM + 专用的“角色提示词”。
*   **过程**：
    1.  系统捕获上传的文件，并调用一个预设的“角色提示词”（例如，“文档分析与任务分派角色”）。
    2.  LLM 会根据此提示词，分析文件的元数据（文件名、类型等）或少量初始内容。
    3.  LLM 的任务是**识别出处理该文档的最佳意图**，并输出一个包含具体指令的**结构化数据**（推荐使用 JSON 格式）。
*   **输出示例**：
    *   *输入文件*：`Q3_Sales_Report.pdf`
    *   *LLM输出 (JSON)*：
        ```json
        {
          "intent": "analyze_sales_data",
          "doc_type": "pdf_with_tables",
          "language": "en"
        }
        ```

**第 3 步：工具执行（Tool Execution）**
*   **执行者**：系统调度器 + 匹配的“mcp工具”。
*   **过程**：
    1.  系统调度器根据第 2 步输出的 `intent` 或 `doc_type` 字段，从“工具库”中查找并匹配到一个合适的工具。
    2.  调度器将原始文档内容和 LLM 输出的 JSON 对象作为参数，调用该工具。
    3.  工具根据接收到的参数，执行其预设的处理逻辑。
*   **输出示例**：
    *   *匹配工具*：`SalesDataExtractorTool`
    *   *工具执行*：该工具被调用，接收到 `doc_type: "pdf_with_tables"` 参数，因此它会优先使用表格解析逻辑来提取 `Q3_Sales_Report.pdf` 中的数据，并忽略无关的文本段落。
    *   *工具输出*：一个包含高质量、干净文本块（chunks）的数组。

**第 4 步：向量化与存储（Vectorization & Storage）**
*   **执行者**：向量化模块。
*   **过程**：
    1.  系统获取“mcp工具”输出的干净文本块数组。
    2.  将这些文本块送入嵌入模型（Embedding Model），生成向量。
    3.  为这批向量创建一个新的、独立的向量数据库实例或集合，并完成存储。

#### **4. 关键组件定义**

*   **角色提示词 (Role Prompt)**
    *   **用途**：定义 LLM 在“意图识别”阶段的行为模式。它不用于全文写作，而是引导 LLM 进行分析、分类和指令生成。
    *   **产出**：必须是稳定、可预测的结构化数据（如JSON）。

*   **mcp工具 (MCP Tool)**
    *   **用途**：一个封装了特定处理逻辑的标准化、可复用的程序模块。
    *   **特点**：确定性。即给定相同的输入，总是产生相同的输出。
    *   **标准化接口（建议）**：所有工具都应遵循一个通用接口，以便于系统统一调度和未来扩展。例如：`execute(document_content, parameters_json)`。

#### **5. 待决策的关键设计点**

在您开始编写“角色”和相关代码时，需要优先思考并确定以下几个关键的设计决策：

1.  **意图与工具的映射机制**：
    *   系统如何将 LLM 输出的意图（如 `"intent": "analyze_sales_data"`）映射到具体的 `SalesDataExtractorTool`？
    *   **方案A（简单）**：在代码中使用 `if-else` 或 `switch` 语句硬编码。
    *   **方案B（推荐）**：创建一个“工具注册表”（可以是一个JSON文件或数据库表），其中定义了每个 `intent` 对应的工具名称、路径等信息。这样更灵活，便于未来在不修改核心代码的情况下增加新工具。

2.  **工具的标准化接口定义**：
    *   我们需要为所有“mcp工具”定义一个严格的输入和输出格式。
    *   **建议接口**：
        *   **输入**：一个包含 `(original_file_content, json_parameters)` 的对象。
        *   **输出**：一个 `string[]` 数组，其中每个字符串都是一个准备好被向量化的文本块。
    *   这需要形成一个明确的开发者规范。

3.  **用户交互（UI/UX）设计**：
    *   在整个处理流程中，用户是否可见或可干预？
    *   **方案A（全自动）**：所有处理在后台完成，用户只看到最终结果。
    *   **方案B（人机协同）**：在“意图识别”后，前端界面可以向用户展示一个确认信息（例如：“系统已识别该文件为‘销售报告’，将使用‘表格数据提取’方案进行处理。是否继续？”），允许用户在必要时进行修正。这会增加灵活性，但也会增加开发复杂度。
